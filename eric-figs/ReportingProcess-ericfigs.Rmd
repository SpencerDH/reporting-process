---
title: "Reporting Process figures"
author: "Eric Marty"
date: August 3, 2017
output: 
  html_notebook:
    toc: true
    toc_float: true
    depth: 5
    number_sections: true
header-includes:
   - \usepackage{amsmath}
---

# Load Dependencies - depricated

```{r eval=FALSE}
source("R/helpers.R")

# Loads built-in packages
library(graphics) # standard R package
library(grDevices) # standard R package
library(utils) # standard R package
library(stats) # standard R package

# usePackage() installs package if not installed, then loads the package
usePackage("scales")
usePackage("zoo")
usePackage("reshape")
usePackage("magick") # for conversion of vector plots to bitmap images
usePackage("magrittr")
usePackage("data.tree") # to document project folder structure
usePackage("latex2exp")

# ensure custom spaero (version 0.2.0.9000) installed and loaded
if(require(spaero)) detach(package:spaero)
if("spaero" %in% rownames(installed.packages()) == TRUE && packageVersion("spaero") != "0.2.0.9000") {
    remove.packages("spaero")
    install.packages("install/spaero_0.2.0.9000.tar.gz", repos = NULL, type="source")
}else{
  if("spaero" %in% rownames(installed.packages()) == FALSE) {
    install.packages("install/spaero_0.2.0.9000.tar.gz", repos = NULL, type="source")
  }
}
library(spaero)

```

# Load Dependencies
```{r eval=FALSE}
# using packrat
source("R/header.R")
```

# Project structure

This R project is managed with {packrat}

```{r echo = FALSE}
thisdir <- "."
filelist <- list.files(path = thisdir, recursive = TRUE, include.dirs = TRUE) 
ls <- data.frame(
      filename = sapply(filelist, function(file) paste0(".","/",file)), 
      file.info(paste(thisdir, filelist, sep = .Platform$file.sep)),
      stringsAsFactors = FALSE
    )
fileStructure <- as.Node(ls, pathName = "filename")
fileStructure
```


# Run Simulations

```{r echo=TRUE}
source("simulation.R")
```

# Summary of Simulation and Reporting Scenarios:
  
recovery rate = 1/7 per day
reporting probability $\rho$ = 2 ^ seq(from = -8, to = 0, length = 21)  
neg. binomial dispersion $\phi$ = {0.01, 0.1, 1, 10, 100}  
aggregation perdiod (days) = {7, 30}  
bandwidth = {35, 100}

$1*21*5*2*2 = 420 \text{ unique combinations}$


# Simulation parameters

```{r echo=FALSE}
load("./output/data/sim_params.Rda")
sim_params
```



# Fig. 1: Overview (reporting probablility and dispersion)

```{r eval=FALSE, warning=FALSE, results='hide'}
source("fig1.R")

# convert figure from PDF to PNG
path <- "./output/plots/fig1.pdf"

targetfmt <- "png"
pdf <- image_read(path, density = "300x300")
png <- image_convert(pdf, format=targetfmt, depth=8)
image_write(png, path = paste0(path,".", format=targetfmt), format = targetfmt)

targetfmt <- "tiff"
pdf <- image_read(path, density = "300x300")
png <- image_convert(pdf, format=targetfmt, depth=8)
image_write(png, path = paste0(path,".", format=targetfmt), format = targetfmt)
```
![Simulated epidemic approaching the epidemic threshold. The bottom panel shows weekly snapshots of the true number of infected in grey, weekly aggregated case reports in light red, and monthly (30 day) aggregated case reports in dark red. Case reports are subject to negative binomially distributed reporting error, with reporting probability $\rho = 0.1088$ and dispersion parameter $\phi = 100$ for weekly reports and $\phi = 1$ for monthly reports (further details in methods section). Transmission dynamics are modeled using the SIR model with birth and death with average population size $N_0 = 10^6$, importation rate $\zeta = 1$ case per week, mean life expectancy 70 years, and mean infectious period 1 week. $R_0$ increases from 0 to 1 over 20 years. Simulations performed using the Gillespie algorithm. The top panel shows the lag 1 autocorrelation calculated using a centered moving window from various different time series data sets, as indicated in the figure. Changing the data changes not only the values of the autocorrelation, but also the trend, quantified using Kendall's $\tau$. The moving window average is calculated using a bandwidth $b = 35$, for details see the methods section.](./output/plots/fig1.pdf.png)



# Fig 2.  Aggregation process and aggregation-based mismatch

- Infection period = 7 days  
- Reporting period = 7 days vs 30 days 
- Reporting probability = 1
- Dispersion = NA

  
```{r eval=FALSE, warning=FALSE, results='hide'}

source("fig2.R")

# convert figure from PDF to PNG
targetfmt <- "png"
pdf <- image_read(path, density = "300x300")
png <- image_convert(pdf, format=targetfmt, depth=8)
image_write(png, path = paste0(path,".", format=targetfmt), format = targetfmt)

```

![Figure 2. Example of aggregation process and agregation-based mismatch.  Illustration of the aggregation of case reports for a disease with average infectious period of 7 days.  In the lower panel, each black line segment represents the infectious period of a simulated individual, from onset of infection to recovery.  Each black dot represents a case report, which in this simulation corresponds to recovery of the individual ($I \rightarrow R$ transitions).  Dotted blue verticals delineate one-week reporting windows; dashed red verticals delineate 30-day reporting windows.  Counting the number of segments present at any given time gives the true number of infected, plotted as a black trace in the upper plot.  Counting the number of dots in a given window gives the number of case reports for that window, plotted as blue (7-day) and red (30-day) traces in the upper plot.](./output/plots/fig2.pdf.png)

# Fig. 3: Example of reporting error

- Infection period = 7 days  
- Reporting period = 7 days

- Reporting probability = 1 Dispersion = NA  
  vs  
  Reporting probability = 0.25 and Dispersion = 0.1


```{r eval=FALSE, warning=FALSE, results='hide'}

source("fig3.R")

## convert figure from PDF to PNG
targetfmt <- "png"
pdf <- image_read(path, density = "300x300")
png <- image_convert(pdf, format=targetfmt, depth=8)
image_write(png, path = paste0(path,".", format=targetfmt), format = targetfmt)

```
![Example of aggregated data with reporting error. Three time series for the same simulated outbreak are shown: daily snapshots of the number of infected (black line), weekly aggregated case reports with no reporting error (perfect reporting, blue line) and weekly aggregated case reports with reporting error (imperfect reporting, red line). Reporting error is modelled using a negative binomial distribution with $\rho = 0.25$ and $\phi = 0.1$. The high overdispersion (small $\phi$) means that there is little visual correspondance between the number of case reports with and without reporting error. Additionally, the number of case reports can exceed the true number of cases (overreporting), in spite of the low reporting rate. SIR simulations performed using the same parameters are Fig.~\ref{fig:fig1}](./output/plots/fig3.pdf.png) 

# Session info

```{r echo=FALSE}
sessionInfo()
```
